"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.NotificationManage = void 0;
const Errors = require("./errors");
const node_fetch_1 = require("node-fetch");
class NotificationManage {
    constructor(baseUrl, options) {
        this.initComplete = false;
        baseUrl = baseUrl.slice(-1) === "/" ? baseUrl.slice(0, -1) : baseUrl;
        if (!this.isUrl(baseUrl))
            throw new Errors.ArgumentError("baseUrl is invalid.");
        this.baseUrl = baseUrl;
        this.authorizationToken = options.authorizationToken;
    }
    getBaseUrl() {
        return this.baseUrl;
    }
    setAuthorizationToken(authorizationToken) {
        this.authorizationToken = authorizationToken;
    }
    configureForOverrideCustomer(customerID) {
        this.customerID = customerID;
    }
    clearOverrideCustomer() {
        this.customerID = undefined;
        this.initComplete = false;
    }
    async getInfo() {
        const uri = "/manage/info";
        return await this.executeRequest(uri, "GET", "get-info");
    }
    async generateApiKey() {
        let uri = "/manage/apikey";
        return await this.executeRequest(uri, "POST", "create-apikey");
    }
    async getMessages(pageSize, nextPageID) {
        let uri = "/manage/customer/{{customerID}}/messages";
        return await this.executeRequest(uri, "GET", "list-message", undefined, {
            pagesize: pageSize,
            nextpage: nextPageID,
        });
    }
    async getMessage(messageID) {
        const uri = `/manage/customer/{{customerID}}/message/${encodeURIComponent(messageID)}`;
        return await this.executeRequest(uri, "GET", "get-message");
    }
    async createEmailMessage(emailMessage, test) {
        const uri = "/manage/customer/{{customerID}}/message";
        const contentType = test ? "create-test-email-message" : "create-email-message";
        return await this.executeRequest(uri, "POST", contentType, emailMessage);
    }
    async createSmsMessage(smsMessage, test) {
        const uri = "/manage/customer/{{customerID}}/message";
        const contentType = test ? "create-test-sms-message" : "create-sms-message";
        return await this.executeRequest(uri, "POST", contentType, smsMessage);
    }
    async getCustomers(pageSize, nextPageID) {
        let uri = "/manage/customers";
        return await this.executeRequest(uri, "GET", "list-customer", undefined, {
            pagesize: pageSize,
            nextpage: nextPageID,
        });
    }
    async getCustomer(customerID) {
        let uri = "/manage/customer";
        if (customerID != undefined) {
            uri += "/" + encodeURIComponent(customerID);
        }
        return await this.executeRequest(uri, "GET", "get-customer");
    }
    async createCustomer(customer) {
        let uri = "/manage/customer";
        return await this.executeRequest(uri, "POST", "create-customer", customer);
    }
    async updateCustomer(customerID, customer) {
        let uri = `/manage/customer/${encodeURIComponent(customerID)}`;
        return await this.executeRequest(uri, "PATCH", "update-customer", customer);
    }
    async deleteCustomer(customerID) {
        let uri = `/manage/customer/${encodeURIComponent(customerID)}`;
        return await this.executeRequest(uri, "DELETE", "delete-customer");
    }
    async getTemplates(pageSize, nextPageID) {
        const uri = "/manage/customer/{{customerID}}/templates";
        return await this.executeRequest(uri, "GET", "list-template", undefined, {
            pagesize: pageSize,
            nextpage: nextPageID,
        });
    }
    async getTemplate(slug, locale) {
        let uri = `/manage/customer/{{customerID}}/template/${encodeURIComponent(slug)}`;
        if (locale) {
            uri += "/" + encodeURIComponent(locale);
        }
        return await this.executeRequest(uri, "GET", "get-template");
    }
    async createTemplate(template) {
        const uri = "/manage/customer/{{customerID}}/template";
        return await this.executeRequest(uri, "POST", "create-template", template);
    }
    async updateTemplate(slug, locale, template) {
        let uri = `/manage/customer/{{customerID}}/template/${encodeURIComponent(slug)}`;
        if (locale) {
            uri += "/" + encodeURIComponent(locale);
        }
        return await this.executeRequest(uri, "PATCH", "update-template", template);
    }
    async deleteTemplate(slug, locale) {
        let uri = `/manage/customer/{{customerID}}/template/${encodeURIComponent(slug)}`;
        if (locale) {
            uri += "/" + encodeURIComponent(locale);
        }
        return await this.executeRequest(uri, "DELETE", "delete-template");
    }
    async getSenders(pageSize, nextPageID) {
        const uri = "/manage/customer/{{customerID}}/senders";
        return await this.executeRequest(uri, "GET", "list-sender", undefined, {
            pagesize: pageSize,
            nextpage: nextPageID,
        });
    }
    async getSender(senderID) {
        const uri = `/manage/customer/{{customerID}}/sender/${encodeURIComponent(senderID)}`;
        return await this.executeRequest(uri, "GET", "get-sender");
    }
    async createSender(sender) {
        const uri = "/manage/customer/{{customerID}}/sender";
        return await this.executeRequest(uri, "POST", "create-sender", sender);
    }
    async updateSender(senderID, sender) {
        const uri = `/manage/customer/{{customerID}}/sender/${encodeURIComponent(senderID)}`;
        return await this.executeRequest(uri, "PATCH", "update-sender", sender);
    }
    async deleteSender(senderID) {
        const uri = `/manage/customer/{{customerID}}/sender/${encodeURIComponent(senderID)}`;
        return await this.executeRequest(uri, "DELETE", "delete-sender");
    }
    async getAppKeys(pageSize, nextPageID) {
        const uri = "/manage/customer/{{customerID}}/appkeys";
        return await this.executeRequest(uri, "GET", "list-appkey", undefined, {
            pagesize: pageSize,
            nextpage: nextPageID,
        });
    }
    async getAppKey(appKeyID) {
        const uri = `/manage/customer/{{customerID}}/appkey/${encodeURIComponent(appKeyID)}`;
        return await this.executeRequest(uri, "GET", "get-appkey");
    }
    async createAppKey(appKey) {
        const uri = "/manage/customer/{{customerID}}/appkey";
        return await this.executeRequest(uri, "POST", "create-appkey", appKey);
    }
    async updateAppKey(appKeyID, appKey) {
        const uri = `/manage/customer/{{customerID}}/appkey/${encodeURIComponent(appKeyID)}`;
        return await this.executeRequest(uri, "PATCH", "update-appkey", appKey);
    }
    async deleteAppKey(appKeyID) {
        const uri = `/manage/customer/{{customerID}}/appkey/${encodeURIComponent(appKeyID)}`;
        return await this.executeRequest(uri, "DELETE", "delete-appkey");
    }
    async getBlocks(pageSize, nextPageID) {
        const uri = "/manage/customer/{{customerID}}/blocks";
        return await this.executeRequest(uri, "GET", "list-block", undefined, {
            pagesize: pageSize,
            nextpage: nextPageID,
        });
    }
    async getBlock(blockID) {
        const uri = `/manage/customer/{{customerID}}/block/${encodeURIComponent(blockID)}`;
        return await this.executeRequest(uri, "GET", "get-block");
    }
    async createBlock(block) {
        const uri = "/manage/customer/{{customerID}}/block";
        return await this.executeRequest(uri, "POST", "create-block", block);
    }
    async deleteBlock(blockID) {
        const uri = `/manage/customer/{{customerID}}/block/${encodeURIComponent(blockID)}`;
        await this.executeRequest(uri, "DELETE", "delete-block");
    }
    async executeRequest(uri, method, contentTypeResource, requestBody, queryParameters) {
        await this.initClient();
        uri = uri.replace(/{{customerID}}/, encodeURIComponent(this.customerID));
        let qp = "";
        if (queryParameters) {
            for (const [k, v] of Object.entries(queryParameters)) {
                if (v === undefined || v === null) {
                    delete queryParameters[k];
                }
            }
            qp = "?" + new URLSearchParams(queryParameters);
        }
        let requestData = undefined;
        if (requestBody) {
            requestData = (typeof requestBody === "string") ? requestBody : JSON.stringify(requestBody);
        }
        let responseBodyText = undefined;
        let responseBody = undefined;
        let response;
        try {
            response = await (0, node_fetch_1.default)(this.baseUrl + uri + qp, {
                method,
                headers: {
                    "Content-Type": `application/vnd.notification.${contentTypeResource}.v1+json`,
                    "Authorization": this.authorizationToken,
                },
                body: requestData,
            });
            responseBodyText = await response.text();
        }
        catch (ex) {
            throw new Errors.FetchError(ex.message, { cause: ex });
        }
        if (!response) {
            throw new Errors.ResponseError("Server did not respond");
        }
        if (response.status === 401 || response.status === 403) {
            throw new Errors.AuthorizationError("Authorization Failed");
        }
        else if (response.status === 404) {
            throw new Errors.ResponseError("Resource not found");
        }
        try {
            responseBody = responseBodyText && JSON.parse(responseBodyText);
        }
        catch (ex) {
            throw new Errors.ResponseError("Invalid response content", { cause: responseBodyText });
        }
        if (response.status != 200) {
            throw new Errors.ResponseError(responseBody.Error || responseBodyText);
        }
        return responseBody;
    }
    async initClient() {
        if (this.initComplete)
            return;
        this.initComplete = true;
        try {
            const dataItem = await this.getInfo();
            this.customerID = dataItem.CustomerID;
        }
        catch (ex) {
            this.initComplete = false;
            const error = ex;
            if (error instanceof Errors.AuthorizationError)
                throw error;
            else
                throw new Errors.InitError(`Failed to init client: ${error.message}`, { cause: error });
        }
    }
    isUrl(value) {
        try {
            const url = new URL(value);
            return url.protocol === "http:" || url.protocol === "https:";
        }
        catch { }
        return false;
    }
}
exports.NotificationManage = NotificationManage;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm90aWZpY2F0aW9uLW1hbmFnZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm5vdGlmaWNhdGlvbi1tYW5hZ2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsbUNBQW1DO0FBRW5DLDJDQUE2QztBQUU3QyxNQUFhLGtCQUFrQjtJQU05QixZQUFZLE9BQWMsRUFBRSxPQUF1QztRQUYzRCxpQkFBWSxHQUFXLEtBQUssQ0FBQztRQUdwQyxPQUFPLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDO1FBRXJFLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQztZQUFFLE1BQU0sSUFBSSxNQUFNLENBQUMsYUFBYSxDQUFDLHFCQUFxQixDQUFDLENBQUM7UUFFaEYsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7UUFDdkIsSUFBSSxDQUFDLGtCQUFrQixHQUFHLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQztJQUN0RCxDQUFDO0lBS0QsVUFBVTtRQUNULE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQztJQUNyQixDQUFDO0lBS0QscUJBQXFCLENBQUMsa0JBQXlCO1FBQzlDLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxrQkFBa0IsQ0FBQztJQUM5QyxDQUFDO0lBS0QsNEJBQTRCLENBQUMsVUFBaUI7UUFDN0MsSUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUM7SUFDOUIsQ0FBQztJQUtELHFCQUFxQjtRQUNwQixJQUFJLENBQUMsVUFBVSxHQUFHLFNBQVMsQ0FBQztRQUM1QixJQUFJLENBQUMsWUFBWSxHQUFHLEtBQUssQ0FBQztJQUMzQixDQUFDO0lBS0QsS0FBSyxDQUFDLE9BQU87UUFDWixNQUFNLEdBQUcsR0FBRyxjQUFjLENB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Q0FBQyxLQUFZO1FBQ3pCLElBQUk7WUFDSCxNQUFNLEdBQUcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUMzQixPQUFPLEdBQUcsQ0FBQyxRQUFRLEtBQUssT0FBTyxJQUFJLEdBQUcsQ0FBQyxRQUFRLEtBQUssUUFBUSxDQUFDO1NBQzdEO1FBQUMsTUFBTSxHQUFHO1FBRVgsT0FBTyxLQUFLLENBQUM7SUFDZCxDQUFDO0NBQ0Q7QUE1YkQsZ0RBNGJDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgRXJyb3JzIGZyb20gXCIuL2Vycm9yc1wiO1xuaW1wb3J0ICogYXMgVHlwZXMgZnJvbSBcIi4vdHlwZXNcIjtcbmltcG9ydCBmZXRjaCwgeyBSZXNwb25zZSB9IGZyb20gXCJub2RlLWZldGNoXCI7XG5cbmV4cG9ydCBjbGFzcyBOb3RpZmljYXRpb25NYW5hZ2Uge1xuXHRwcml2YXRlIGJhc2VVcmw6c3RyaW5nO1xuXHRwcml2YXRlIGF1dGhvcml6YXRpb25Ub2tlbjpzdHJpbmc7XG5cdHByaXZhdGUgY3VzdG9tZXJJRDpzdHJpbmd8dW5kZWZpbmVkO1xuXHRwcml2YXRlIGluaXRDb21wbGV0ZTpib29sZWFuID0gZmFsc2U7XG5cblx0Y29uc3RydWN0b3IoYmFzZVVybDpzdHJpbmcsIG9wdGlvbnM6VHlwZXMuTm90aWZpY2F0aW9uTWFuYWdlT3B0aW9ucykge1xuXHRcdGJhc2VVcmwgPSBiYXNlVXJsLnNsaWNlKC0xKSA9PT0gXCIvXCIgPyBiYXNlVXJsLnNsaWNlKDAsIC0xKSA6IGJhc2VVcmw7XHQvLyByZW1vdmUgdHJhaWxpbmcgc2xhc2hcblxuXHRcdGlmICghdGhpcy5pc1VybChiYXNlVXJsKSkgdGhyb3cgbmV3IEVycm9ycy5Bcmd1bWVudEVycm9yKFwiYmFzZVVybCBpcyBpbnZhbGlkLlwiKTtcblxuXHRcdHRoaXMuYmFzZVVybCA9IGJhc2VVcmw7XG5cdFx0dGhpcy5hdXRob3JpemF0aW9uVG9rZW4gPSBvcHRpb25zLmF1dGhvcml6YXRpb25Ub2tlbjtcblx0fVxuXG5cdC8qKlxuXHQgKiBHZXQgdGhlIGJhc2VVcmxcblx0ICovXG5cdGdldEJhc2VVcmwoKTpzdHJpbmcge1xuXHRcdHJldHVybiB0aGlzLmJhc2VVcmw7XG5cdH1cblxuXHQvKipcblx0ICogU2V0IHRoZSBhdXRob3JpemF0aW9uIHRva2VuLiBVc2VkIGJ5IGFsbCBmdXR1cmUgcmVxdWVzdHMuXG5cdCAqL1xuXHRzZXRBdXRob3JpemF0aW9uVG9rZW4oYXV0aG9yaXphdGlvblRva2VuOnN0cmluZyk6dm9pZCB7XG5cdFx0dGhpcy5hdXRob3JpemF0aW9uVG9rZW4gPSBhdXRob3JpemF0aW9uVG9rZW47XG5cdH1cblxuXHQvKipcblx0ICogU2V0IHRoZSBDdXN0b21lciBJRCB0aGF0IHdpbGwgYmUgcGFzc2VkIHRvIGFsbCBBUEkgcmVxdWVzdHMuXG5cdCAqL1xuXHRjb25maWd1cmVGb3JPdmVycmlkZUN1c3RvbWVyKGN1c3RvbWVySUQ6c3RyaW5nKTp2b2lkIHtcblx0XHR0aGlzLmN1c3RvbWVySUQgPSBjdXN0b21lcklEO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJlbW92ZSB0aGUgQ3VzdG9tZXIgSUQuIFRoZSBjdXN0b21lciBmb3IgdGhlIEF1dGhvcml6YXRpb24gVG9rZW4gd2lsbCBiZSB1c2VkIGZvciByZXF1ZXN0cy5cblx0ICovXG5cdGNsZWFyT3ZlcnJpZGVDdXN0b21lcigpIHtcblx0XHR0aGlzLmN1c3RvbWVySUQgPSB1bmRlZmluZWQ7XG5cdFx0dGhpcy5pbml0Q29tcGxldGUgPSBmYWxzZTtcblx0fVxuXG5cdC8qKlxuXHQgKiBHZXQgYW4gaW5mbyBvYmplY3QgZm9yIHRoZSBhdXRob3JpemVkIGN1c3RvbWVyLlxuXHQgKi9cblx0YXN5bmMgZ2V0SW5mbygpOlByb21pc2U8VHlwZXMuQ3VzdG9tZXJJbmZvPiB7XG5cdFx0Y29uc3QgdXJpID0gXCIvbWFuYWdlL2luZm9cIjtcblxuXHRcdHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVSZXF1ZXN0PFR5cGVzLkN1c3RvbWVySW5mbz4odXJpLCBcIkdFVFwiLCBcImdldC1pbmZvXCIpO1xuXHR9XG5cblx0LyoqXG5cdCAqIEdlbmVyYXRlcyBhIHZhbGlkIEFQSSBrZXkuXG5cdCAqL1xuXHRhc3luYyBnZW5lcmF0ZUFwaUtleSgpOlByb21pc2U8VHlwZXMuQXBpS2V5UmVzdWx0PiB7XG5cdFx0bGV0IHVyaSA9IFwiL21hbmFnZS9hcGlrZXlcIjtcblxuXHRcdHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVSZXF1ZXN0PFR5cGVzLkFwaUtleVJlc3VsdD4odXJpLCBcIlBPU1RcIiwgXCJjcmVhdGUtYXBpa2V5XCIpO1xuXHR9XG5cblx0LyoqXG5cdCAqIEdldCBhIGxpc3Qgb2YgbWVzc2FnZXMuIExpbWl0cyB0aGUgbnVtYmVyIG9mIHJlY29yZHMgYnkgcGFnZVNpemUgYW5kIHN0YXJ0aW5nIHdpdGggdGhlIHJlY29yZCBhdCBuZXh0UGFnZUlELlxuXHQgKi9cblx0YXN5bmMgZ2V0TWVzc2FnZXMocGFnZVNpemU6bnVtYmVyLCBuZXh0UGFnZUlEPzpzdHJpbmcpOlByb21pc2U8VHlwZXMuTWVzc2FnZUxpc3Q+IHtcblx0XHRsZXQgdXJpID0gXCIvbWFuYWdlL2N1c3RvbWVyL3t7Y3VzdG9tZXJJRH19L21lc3NhZ2VzXCI7XG5cblx0XHRyZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlUmVxdWVzdDxUeXBlcy5NZXNzYWdlTGlzdD4odXJpLCBcIkdFVFwiLCBcImxpc3QtbWVzc2FnZVwiLCB1bmRlZmluZWQsIHtcblx0XHRcdHBhZ2VzaXplOiBwYWdlU2l6ZSxcblx0XHRcdG5leHRwYWdlOiBuZXh0UGFnZUlELFxuXHRcdH0pO1xuXHR9XG5cblx0LyoqXG5cdCAqIEdldCBhIG1lc3NhZ2UgcmVjb3JkLlxuXHQgKi9cblx0YXN5bmMgZ2V0TWVzc2FnZShtZXNzYWdlSUQ6c3RyaW5nKTpQcm9taXNlPFR5cGVzLk1lc3NhZ2U+IHtcblx0XHRjb25zdCB1cmkgPSBgL21hbmFnZS9jdXN0b21lci97e2N1c3RvbWVySUR9fS9tZXNzYWdlLyR7ZW5jb2RlVVJJQ29tcG9uZW50KG1lc3NhZ2VJRCl9YDtcblxuXHRcdHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVSZXF1ZXN0PFR5cGVzLk1lc3NhZ2U+KHVyaSwgXCJHRVRcIiwgXCJnZXQtbWVzc2FnZVwiKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBDcmVhdGUgYW4gZW1haWwgbWVzc2FnZS5cblx0ICovXG5cdGFzeW5jIGNyZWF0ZUVtYWlsTWVzc2FnZShlbWFpbE1lc3NhZ2U6VHlwZXMuQ3JlYXRlRW1haWxNZXNzYWdlLCB0ZXN0OmJvb2xlYW4pOlByb21pc2U8VHlwZXMuQ3JlYXRlTWVzc2FnZVJlc3VsdD4ge1xuXHRcdGNvbnN0IHVyaSA9IFwiL21hbmFnZS9jdXN0b21lci97e2N1c3RvbWVySUR9fS9tZXNzYWdlXCI7XG5cdFx0Y29uc3QgY29udGVudFR5cGUgPSB0ZXN0ID8gXCJjcmVhdGUtdGVzdC1lbWFpbC1tZXNzYWdlXCIgOiBcImNyZWF0ZS1lbWFpbC1tZXNzYWdlXCI7XG5cblx0XHRyZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlUmVxdWVzdDxUeXBlcy5DcmVhdGVNZXNzYWdlUmVzdWx0Pih1cmksIFwiUE9TVFwiLCBjb250ZW50VHlwZSwgZW1haWxNZXNzYWdlKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBDcmVhdGUgYW4gU01TIG1lc3NhZ2UuXG5cdCAqL1xuXHRhc3luYyBjcmVhdGVTbXNNZXNzYWdlKHNtc01lc3NhZ2U6VHlwZXMuQ3JlYXRlU21zTWVzc2FnZSwgdGVzdDpib29sZWFuKTpQcm9taXNlPFR5cGVzLkNyZWF0ZU1lc3NhZ2VSZXN1bHQ+IHtcblx0XHRjb25zdCB1cmkgPSBcIi9tYW5hZ2UvY3VzdG9tZXIve3tjdXN0b21lcklEfX0vbWVzc2FnZVwiO1xuXHRcdGNvbnN0IGNvbnRlbnRUeXBlID0gdGVzdCA/IFwiY3JlYXRlLXRlc3Qtc21zLW1lc3NhZ2VcIiA6IFwiY3JlYXRlLXNtcy1tZXNzYWdlXCI7XG5cblx0XHRyZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlUmVxdWVzdDxUeXBlcy5DcmVhdGVNZXNzYWdlUmVzdWx0Pih1cmksIFwiUE9TVFwiLCBjb250ZW50VHlwZSwgc21zTWVzc2FnZSk7XG5cdH1cblxuXHQvKipcblx0ICogR2V0IGEgbGlzdCBvZiBjdXN0b21lcnMuIE9ubHkgYW4gYWRtaW4gYXBwIGtleSBjYW4gbWFrZSB0aGlzIHJlcXVlc3QuXG5cdCAqIExpbWl0cyB0aGUgbnVtYmVyIG9mIHJlY29yZHMgYnkgcGFnZVNpemUgYW5kIHN0YXJ0aW5nIHdpdGggdGhlIHJlY29yZCBhdCBuZXh0UGFnZUlELlxuXHQgKi9cblx0YXN5bmMgZ2V0Q3VzdG9tZXJzKHBhZ2VTaXplOm51bWJlciwgbmV4dFBhZ2VJRD86c3RyaW5nKTpQcm9taXNlPFR5cGVzLkN1c3RvbWVyTGlzdD4ge1xuXHRcdGxldCB1cmkgPSBcIi9tYW5hZ2UvY3VzdG9tZXJzXCI7XHQvLyBUaGlzIFVSSSBpcyBkaWZmZXJlbnQuIFdlIGRvbid0IGVtYmVkIHRoZSBjbGllbnQgY3VzdG9tZXIgaWQgYmVjYXVzZSB0aGUgZ2V0IGN1c3RvbWVycyBlbmRwb2ludCBkb2VzIG5vdCB1c2UgaXQuXG5cblx0XHRyZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlUmVxdWVzdDxUeXBlcy5DdXN0b21lckxpc3Q+KHVyaSwgXCJHRVRcIiwgXCJsaXN0LWN1c3RvbWVyXCIsIHVuZGVmaW5lZCwge1xuXHRcdFx0cGFnZXNpemU6IHBhZ2VTaXplLFxuXHRcdFx0bmV4dHBhZ2U6IG5leHRQYWdlSUQsXG5cdFx0fSk7XG5cdH1cblxuXHQvKipcblx0ICogR2V0IGEgY3VzdG9tZXIgcmVjb3JkLiBPbmx5IGFuIGFkbWluIGFwcCBrZXkgY2FuIGdldCBjdXN0b21lciByZWNvcmRzIG90aGVyIHRoYW4gaXRzIG93bi5cblx0ICovXG5cdGFzeW5jIGdldEN1c3RvbWVyKGN1c3RvbWVySUQ/OnN0cmluZ3x1bmRlZmluZWQpOlByb21pc2U8VHlwZXMuQ3VzdG9tZXI+IHtcblx0XHRsZXQgdXJpID0gXCIvbWFuYWdlL2N1c3RvbWVyXCI7XHQvLyBUaGlzIFVSSSBpcyBkaWZmZXJlbnQuIFdlIGRvbid0IGVtYmVkIHRoZSBjbGllbnQgY3VzdG9tZXIgaWQgYmVjYXVzZSB0aGUgZ2V0IGN1c3RvbWVyIGVuZHBvaW50IGRvZXMgbm90IHVzZSBpdC5cblxuXHRcdGlmIChjdXN0b21lcklEICE9IHVuZGVmaW5lZCkge1xuXHRcdFx0dXJpICs9IFwiL1wiICsgZW5jb2RlVVJJQ29tcG9uZW50KGN1c3RvbWVySUQpO1xuXHRcdH1cblxuXHRcdHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVSZXF1ZXN0PFR5cGVzLkN1c3RvbWVyPih1cmksIFwiR0VUXCIsIFwiZ2V0LWN1c3RvbWVyXCIpO1xuXHR9XG5cblx0LyoqXG5cdCAqIENyZWF0ZXMgYSBuZXcgY3VzdG9tZXIuIE9ubHkgYW4gYWRtaW4gYXBwIGtleSBjYW4gY3JlYXRlIGN1c3RvbWVycy5cblx0ICovXG5cdGFzeW5jIGNyZWF0ZUN1c3RvbWVyKGN1c3RvbWVyOlR5cGVzLkNyZWF0ZUN1c3RvbWVyRGF0YSk6UHJvbWlzZTxUeXBlcy5DdXN0b21lcj4ge1xuXHRcdGxldCB1cmkgPSBcIi9tYW5hZ2UvY3VzdG9tZXJcIjtcdC8vIFRoaXMgVVJJIGlzIGRpZmZlcmVudC4gV2UgZG9uJ3QgZW1iZWQgdGhlIGNsaWVudCBjdXN0b21lciBpZCBiZWNhdXNlIHRoZSBjcmVhdGUgY3VzdG9tZXIgZW5kcG9pbnQgZG9lcyBub3QgdXNlIGl0LlxuXG5cdFx0cmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZVJlcXVlc3Q8VHlwZXMuQ3VzdG9tZXI+KHVyaSwgXCJQT1NUXCIsIFwiY3JlYXRlLWN1c3RvbWVyXCIsIGN1c3RvbWVyKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBVcGRhdGUgYW4gZXhpc3RpbmcgY3VzdG9tZXIuXG5cdCAqL1xuXHRhc3luYyB1cGRhdGVDdXN0b21lcihjdXN0b21lcklEOnN0cmluZywgY3VzdG9tZXI6VHlwZXMuVXBkYXRlQ3VzdG9tZXJEYXRhKTpQcm9taXNlPFR5cGVzLkN1c3RvbWVyPiB7XG5cdFx0bGV0IHVyaSA9IGAvbWFuYWdlL2N1c3RvbWVyLyR7ZW5jb2RlVVJJQ29tcG9uZW50KGN1c3RvbWVySUQpfWA7XHQvLyBUaGlzIFVSSSBpcyBkaWZmZXJlbnQuIFdlIGRvbid0IGVtYmVkIHRoZSBjbGllbnQgY3VzdG9tZXIgaWQgYmVjYXVzZSB0aGUgdXBkYXRlIGN1c3RvbWVyIGVuZHBvaW50IGRvZXMgdXNlIGl0LlxuXG5cdFx0cmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZVJlcXVlc3Q8VHlwZXMuQ3VzdG9tZXI+KHVyaSwgXCJQQVRDSFwiLCBcInVwZGF0ZS1jdXN0b21lclwiLCBjdXN0b21lcik7XG5cdH1cblxuXHQvKipcblx0ICogRGVsZXRlIGFuIGV4aXN0aW5nIGN1c3RvbWVyLlxuXHQgKi9cblx0YXN5bmMgZGVsZXRlQ3VzdG9tZXIoY3VzdG9tZXJJRDpzdHJpbmcpOlByb21pc2U8dm9pZD4ge1xuXHRcdGxldCB1cmkgPSBgL21hbmFnZS9jdXN0b21lci8ke2VuY29kZVVSSUNvbXBvbmVudChjdXN0b21lcklEKX1gO1x0Ly8gVGhpcyBVUkkgaXMgZGlmZmVyZW50LiBXZSBkb24ndCBlbWJlZCB0aGUgY2xpZW50IGN1c3RvbWVyIGlkIGJlY2F1c2UgdGhlIHVwZGF0ZSBjdXN0b21lciBlbmRwb2ludCBkb2VzIHVzZSBpdC5cblxuXHRcdHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVSZXF1ZXN0PHZvaWQ+KHVyaSwgXCJERUxFVEVcIiwgXCJkZWxldGUtY3VzdG9tZXJcIik7XG5cdH1cblxuXHQvKipcblx0ICogR2V0IGEgbGlzdCBvZiB0ZW1wbGF0ZXMuXG5cdCAqIExpbWl0cyB0aGUgbnVtYmVyIG9mIHJlY29yZHMgYnkgcGFnZVNpemUgYW5kIHN0YXJ0aW5nIHdpdGggdGhlIHJlY29yZCBhdCBuZXh0UGFnZUlELlxuXHQgKi9cblx0YXN5bmMgZ2V0VGVtcGxhdGVzKHBhZ2VTaXplOm51bWJlciwgbmV4dFBhZ2VJRD86c3RyaW5nKTpQcm9taXNlPFR5cGVzLlRlbXBsYXRlTGlzdD4ge1xuXHRcdGNvbnN0IHVyaSA9IFwiL21hbmFnZS9jdXN0b21lci97e2N1c3RvbWVySUR9fS90ZW1wbGF0ZXNcIjtcblxuXHRcdHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVSZXF1ZXN0PFR5cGVzLlRlbXBsYXRlTGlzdD4odXJpLCBcIkdFVFwiLCBcImxpc3QtdGVtcGxhdGVcIiwgdW5kZWZpbmVkLCB7XG5cdFx0XHRwYWdlc2l6ZTogcGFnZVNpemUsXG5cdFx0XHRuZXh0cGFnZTogbmV4dFBhZ2VJRCxcblx0XHR9KTtcblx0fVxuXG5cdC8qKlxuXHQgKiBHZXQgYSB0ZW1wbGF0ZSByZWNvcmQuXG5cdCAqL1xuXHRhc3luYyBnZXRUZW1wbGF0ZShzbHVnOnN0cmluZywgbG9jYWxlOnN0cmluZ3x1bmRlZmluZWQpOlByb21pc2U8VHlwZXMuVGVtcGxhdGU+IHtcblx0XHRsZXQgdXJpID0gYC9tYW5hZ2UvY3VzdG9tZXIve3tjdXN0b21lcklEfX0vdGVtcGxhdGUvJHtlbmNvZGVVUklDb21wb25lbnQoc2x1Zyl9YDtcblx0XHRpZiAobG9jYWxlKSB7XG5cdFx0XHR1cmkgKz0gXCIvXCIgKyBlbmNvZGVVUklDb21wb25lbnQobG9jYWxlKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlUmVxdWVzdDxUeXBlcy5UZW1wbGF0ZT4odXJpLCBcIkdFVFwiLCBcImdldC10ZW1wbGF0ZVwiKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBDcmVhdGVzIGEgbmV3IHRlbXBsYXRlLlxuXHQgKi9cblx0YXN5bmMgY3JlYXRlVGVtcGxhdGUodGVtcGxhdGU6VHlwZXMuQ3JlYXRlVGVtcGxhdGVEYXRhKTpQcm9taXNlPFR5cGVzLlRlbXBsYXRlPiB7XG5cdFx0Y29uc3QgdXJpID0gXCIvbWFuYWdlL2N1c3RvbWVyL3t7Y3VzdG9tZXJJRH19L3RlbXBsYXRlXCI7XG5cblx0XHRyZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlUmVxdWVzdDxUeXBlcy5UZW1wbGF0ZT4odXJpLCBcIlBPU1RcIiwgXCJjcmVhdGUtdGVtcGxhdGVcIiwgdGVtcGxhdGUpO1xuXHR9XG5cblx0LyoqXG5cdCAqIFVwZGF0ZSBhbiBleGlzdGluZyB0ZW1wbGF0ZS5cblx0ICovXG5cdGFzeW5jIHVwZGF0ZVRlbXBsYXRlKHNsdWc6c3RyaW5nLCBsb2NhbGU6c3RyaW5nfHVuZGVmaW5lZCwgdGVtcGxhdGU6VHlwZXMuVXBkYXRlVGVtcGxhdGVEYXRhKTpQcm9taXNlPFR5cGVzLlRlbXBsYXRlPiB7XG5cdFx0bGV0IHVyaSA9IGAvbWFuYWdlL2N1c3RvbWVyL3t7Y3VzdG9tZXJJRH19L3RlbXBsYXRlLyR7ZW5jb2RlVVJJQ29tcG9uZW50KHNsdWcpfWA7XG5cdFx0aWYgKGxvY2FsZSkge1xuXHRcdFx0dXJpICs9IFwiL1wiICsgZW5jb2RlVVJJQ29tcG9uZW50KGxvY2FsZSk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZVJlcXVlc3Q8VHlwZXMuVGVtcGxhdGU+KHVyaSwgXCJQQVRDSFwiLCBcInVwZGF0ZS10ZW1wbGF0ZVwiLCB0ZW1wbGF0ZSk7XG5cdH1cblxuXHQvKipcblx0ICogRGVsZXRlIGFuIGV4aXN0aW5nIHRlbXBsYXRlLlxuXHQgKi9cblx0YXN5bmMgZGVsZXRlVGVtcGxhdGUoc2x1ZzpzdHJpbmcsIGxvY2FsZTpzdHJpbmd8dW5kZWZpbmVkKTpQcm9taXNlPHZvaWQ+IHtcblx0XHRsZXQgdXJpID0gYC9tYW5hZ2UvY3VzdG9tZXIve3tjdXN0b21lcklEfX0vdGVtcGxhdGUvJHtlbmNvZGVVUklDb21wb25lbnQoc2x1Zyl9YDtcblx0XHRpZiAobG9jYWxlKSB7XG5cdFx0XHR1cmkgKz0gXCIvXCIgKyBlbmNvZGVVUklDb21wb25lbnQobG9jYWxlKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlUmVxdWVzdDx2b2lkPih1cmksIFwiREVMRVRFXCIsIFwiZGVsZXRlLXRlbXBsYXRlXCIpO1xuXHR9XG5cblx0LyoqXG5cdCAqIEdldCBhIGxpc3Qgb2Ygc2VuZGVycy5cblx0ICogTGltaXRzIHRoZSBudW1iZXIgb2YgcmVjb3JkcyBieSBwYWdlU2l6ZSBhbmQgc3RhcnRpbmcgd2l0aCB0aGUgcmVjb3JkIGF0IG5leHRQYWdlSUQuXG5cdCAqL1xuXHRhc3luYyBnZXRTZW5kZXJzKHBhZ2VTaXplOm51bWJlciwgbmV4dFBhZ2VJRD86c3RyaW5nKTpQcm9taXNlPFR5cGVzLlNlbmRlckxpc3Q+IHtcblx0XHRjb25zdCB1cmkgPSBcIi9tYW5hZ2UvY3VzdG9tZXIve3tjdXN0b21lcklEfX0vc2VuZGVyc1wiO1xuXG5cdFx0cmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZVJlcXVlc3QodXJpLCBcIkdFVFwiLCBcImxpc3Qtc2VuZGVyXCIsIHVuZGVmaW5lZCwge1xuXHRcdFx0cGFnZXNpemU6IHBhZ2VTaXplLFxuXHRcdFx0bmV4dHBhZ2U6IG5leHRQYWdlSUQsXG5cdFx0fSk7XG5cdH1cblxuXHQvKipcblx0ICogR2V0IGEgc2VuZGVyIHJlY29yZC5cblx0ICovXG5cdGFzeW5jIGdldFNlbmRlcihzZW5kZXJJRDpzdHJpbmcpOlByb21pc2U8VHlwZXMuU2VuZGVyPiB7XG5cdFx0Y29uc3QgdXJpID0gYC9tYW5hZ2UvY3VzdG9tZXIve3tjdXN0b21lcklEfX0vc2VuZGVyLyR7ZW5jb2RlVVJJQ29tcG9uZW50KHNlbmRlcklEKX1gO1xuXG5cdFx0cmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZVJlcXVlc3Q8VHlwZXMuU2VuZGVyPih1cmksIFwiR0VUXCIsIFwiZ2V0LXNlbmRlclwiKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBDcmVhdGVzIGEgbmV3IHNlbmRlci5cblx0ICovXG5cdGFzeW5jIGNyZWF0ZVNlbmRlcihzZW5kZXI6VHlwZXMuQ3JlYXRlU2VuZGVyRGF0YSk6UHJvbWlzZTxUeXBlcy5TZW5kZXI+IHtcblx0XHRjb25zdCB1cmkgPSBcIi9tYW5hZ2UvY3VzdG9tZXIve3tjdXN0b21lcklEfX0vc2VuZGVyXCI7XG5cblx0XHRyZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlUmVxdWVzdDxUeXBlcy5TZW5kZXI+KHVyaSwgXCJQT1NUXCIsIFwiY3JlYXRlLXNlbmRlclwiLCBzZW5kZXIpO1xuXHR9XG5cblx0LyoqXG5cdCAqIFVwZGF0ZSBhbiBleGlzdGluZyBzZW5kZXIuXG5cdCAqL1xuXHRhc3luYyB1cGRhdGVTZW5kZXIoc2VuZGVySUQ6c3RyaW5nLCBzZW5kZXI6VHlwZXMuVXBkYXRlU2VuZGVyRGF0YSk6UHJvbWlzZTxUeXBlcy5TZW5kZXI+IHtcblx0XHRjb25zdCB1cmkgPSBgL21hbmFnZS9jdXN0b21lci97e2N1c3RvbWVySUR9fS9zZW5kZXIvJHtlbmNvZGVVUklDb21wb25lbnQoc2VuZGVySUQpfWA7XG5cblx0XHRyZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlUmVxdWVzdDxUeXBlcy5TZW5kZXI+KHVyaSwgXCJQQVRDSFwiLCBcInVwZGF0ZS1zZW5kZXJcIiwgc2VuZGVyKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBEZWxldGUgYW4gZXhpc3Rpbmcgc2VuZGVyLlxuXHQgKi9cblx0YXN5bmMgZGVsZXRlU2VuZGVyKHNlbmRlcklEOnN0cmluZyk6UHJvbWlzZTx2b2lkPiB7XG5cdFx0Y29uc3QgdXJpID0gYC9tYW5hZ2UvY3VzdG9tZXIve3tjdXN0b21lcklEfX0vc2VuZGVyLyR7ZW5jb2RlVVJJQ29tcG9uZW50KHNlbmRlcklEKX1gO1xuXG5cdFx0cmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZVJlcXVlc3Q8dm9pZD4odXJpLCBcIkRFTEVURVwiLCBcImRlbGV0ZS1zZW5kZXJcIik7XG5cdH1cblxuXHQvKipcblx0ICogR2V0IGEgbGlzdCBvZiBhcHAga2V5cy5cblx0ICogTGltaXRzIHRoZSBudW1iZXIgb2YgcmVjb3JkcyBieSBwYWdlU2l6ZSBhbmQgc3RhcnRpbmcgd2l0aCB0aGUgcmVjb3JkIGF0IG5leHRQYWdlSUQuXG5cdCAqL1xuXHRhc3luYyBnZXRBcHBLZXlzKHBhZ2VTaXplOm51bWJlciwgbmV4dFBhZ2VJRD86c3RyaW5nKTpQcm9taXNlPFR5cGVzLkFwcEtleUxpc3Q+IHtcblx0XHRjb25zdCB1cmkgPSBcIi9tYW5hZ2UvY3VzdG9tZXIve3tjdXN0b21lcklEfX0vYXBwa2V5c1wiO1xuXG5cdFx0cmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZVJlcXVlc3Q8VHlwZXMuQXBwS2V5TGlzdD4odXJpLCBcIkdFVFwiLCBcImxpc3QtYXBwa2V5XCIsIHVuZGVmaW5lZCwge1xuXHRcdFx0cGFnZXNpemU6IHBhZ2VTaXplLFxuXHRcdFx0bmV4dHBhZ2U6IG5leHRQYWdlSUQsXG5cdFx0fSk7XG5cdH1cblxuXHQvKipcblx0ICogR2V0IGFuIGFwcCBrZXkgcmVjb3JkLlxuXHQgKi9cblx0YXN5bmMgZ2V0QXBwS2V5KGFwcEtleUlEOnN0cmluZyk6UHJvbWlzZTxUeXBlcy5BcHBLZXk+IHtcblx0XHRjb25zdCB1cmkgPSBgL21hbmFnZS9jdXN0b21lci97e2N1c3RvbWVySUR9fS9hcHBrZXkvJHtlbmNvZGVVUklDb21wb25lbnQoYXBwS2V5SUQpfWA7XG5cblx0XHRyZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlUmVxdWVzdDxUeXBlcy5BcHBLZXk+KHVyaSwgXCJHRVRcIiwgXCJnZXQtYXBwa2V5XCIpO1xuXHR9XG5cblx0LyoqXG5cdCAqIENyZWF0ZXMgYSBuZXcgYXBwIGtleS5cblx0ICovXG5cdGFzeW5jIGNyZWF0ZUFwcEtleShhcHBLZXk6VHlwZXMuQ3JlYXRlQXBwS2V5RGF0YSk6UHJvbWlzZTxUeXBlcy5BcHBLZXk+IHtcblx0XHRjb25zdCB1cmkgPSBcIi9tYW5hZ2UvY3VzdG9tZXIve3tjdXN0b21lcklEfX0vYXBwa2V5XCI7XG5cblx0XHRyZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlUmVxdWVzdDxUeXBlcy5BcHBLZXk+KHVyaSwgXCJQT1NUXCIsIFwiY3JlYXRlLWFwcGtleVwiLCBhcHBLZXkpO1xuXHR9XG5cblx0LyoqXG5cdCAqIFVwZGF0ZSBhbiBleGlzdGluZyBhcHAga2V5LlxuXHQgKi9cblx0YXN5bmMgdXBkYXRlQXBwS2V5KGFwcEtleUlEOnN0cmluZywgYXBwS2V5OlR5cGVzLlVwZGF0ZUFwcEtleURhdGEpOlByb21pc2U8VHlwZXMuQXBwS2V5PiB7XG5cdFx0Y29uc3QgdXJpID0gYC9tYW5hZ2UvY3VzdG9tZXIve3tjdXN0b21lcklEfX0vYXBwa2V5LyR7ZW5jb2RlVVJJQ29tcG9uZW50KGFwcEtleUlEKX1gO1xuXG5cdFx0cmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZVJlcXVlc3Q8VHlwZXMuQXBwS2V5Pih1cmksIFwiUEFUQ0hcIiwgXCJ1cGRhdGUtYXBwa2V5XCIsIGFwcEtleSk7XG5cdH1cblxuXHQvKipcblx0ICogRGVsZXRlIGFuIGV4aXN0aW5nIGFwcCBrZXkuXG5cdCAqL1xuXHRhc3luYyBkZWxldGVBcHBLZXkoYXBwS2V5SUQ6c3RyaW5nKTpQcm9taXNlPHZvaWQ+IHtcblx0XHRjb25zdCB1cmkgPSBgL21hbmFnZS9jdXN0b21lci97e2N1c3RvbWVySUR9fS9hcHBrZXkvJHtlbmNvZGVVUklDb21wb25lbnQoYXBwS2V5SUQpfWA7XG5cblx0XHRyZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlUmVxdWVzdDx2b2lkPih1cmksIFwiREVMRVRFXCIsIFwiZGVsZXRlLWFwcGtleVwiKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBHZXQgYSBsaXN0IG9mIGJsb2Nrcy5cblx0ICogTGltaXRzIHRoZSBudW1iZXIgb2YgcmVjb3JkcyBieSBwYWdlU2l6ZSBhbmQgc3RhcnRpbmcgd2l0aCB0aGUgcmVjb3JkIGF0IG5leHRQYWdlSUQuXG5cdCAqL1xuXHRhc3luYyBnZXRCbG9ja3MocGFnZVNpemU6bnVtYmVyLCBuZXh0UGFnZUlEPzpTdHJpbmcpOlByb21pc2U8VHlwZXMuQmxvY2tMaXN0PiB7XG5cdFx0Y29uc3QgdXJpID0gXCIvbWFuYWdlL2N1c3RvbWVyL3t7Y3VzdG9tZXJJRH19L2Jsb2Nrc1wiO1xuXG5cdFx0cmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZVJlcXVlc3Q8VHlwZXMuQmxvY2tMaXN0Pih1cmksIFwiR0VUXCIsIFwibGlzdC1ibG9ja1wiLCB1bmRlZmluZWQsIHtcblx0XHRcdHBhZ2VzaXplOiBwYWdlU2l6ZSxcblx0XHRcdG5leHRwYWdlOiBuZXh0UGFnZUlELFxuXHRcdH0pO1xuXHR9XG5cblx0LyoqXG5cdCAqIEdldCBhIGJsb2NrIHJlY29yZC5cblx0ICovXG5cdGFzeW5jIGdldEJsb2NrKGJsb2NrSUQ6c3RyaW5nKTpQcm9taXNlPFR5cGVzLkJsb2NrPiB7XG5cdFx0Y29uc3QgdXJpID0gYC9tYW5hZ2UvY3VzdG9tZXIve3tjdXN0b21lcklEfX0vYmxvY2svJHtlbmNvZGVVUklDb21wb25lbnQoYmxvY2tJRCl9YDtcblxuXHRcdHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVSZXF1ZXN0PFR5cGVzLkJsb2NrPih1cmksIFwiR0VUXCIsIFwiZ2V0LWJsb2NrXCIpO1xuXHR9XG5cblx0LyoqXG5cdCAqIENyZWF0ZXMgYSBuZXcgYmxvY2suXG5cdCAqL1xuXHRhc3luYyBjcmVhdGVCbG9jayhibG9jazpUeXBlcy5DcmVhdGVCbG9ja0RhdGEpOlByb21pc2U8VHlwZXMuQmxvY2s+IHtcblx0XHRjb25zdCB1cmkgPSBcIi9tYW5hZ2UvY3VzdG9tZXIve3tjdXN0b21lcklEfX0vYmxvY2tcIjtcblxuXHRcdHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVSZXF1ZXN0PFR5cGVzLkJsb2NrPih1cmksIFwiUE9TVFwiLCBcImNyZWF0ZS1ibG9ja1wiLCBibG9jayk7XG5cdH1cblxuXHQvKipcblx0ICogRGVsZXRlIGEgYmxvY2suXG5cdCAqL1xuXHRhc3luYyBkZWxldGVCbG9jayhibG9ja0lEOnN0cmluZyk6UHJvbWlzZTx2b2lkPiB7XG5cdFx0Y29uc3QgdXJpID0gYC9tYW5hZ2UvY3VzdG9tZXIve3tjdXN0b21lcklEfX0vYmxvY2svJHtlbmNvZGVVUklDb21wb25lbnQoYmxvY2tJRCl9YDtcblxuXHRcdGF3YWl0IHRoaXMuZXhlY3V0ZVJlcXVlc3Q8dm9pZD4odXJpLCBcIkRFTEVURVwiLCBcImRlbGV0ZS1ibG9ja1wiKTtcblx0fVxuXG5cdC8vIElmIHRoZXJlIGlzIGEgbmV0d29yayByZXNwb25zZSB3aXRoIEpTT04gdGhlbiBhIHR1cGxlIGlzIHJldHVybmVkIChib29sZWFuIHN1Y2Nlc3MsIG9iamVjdCBqc29uQ29udGVudCkuIElmIGFueSBleGNlcHRpb25zIGFyZSB0aHJvd24gdGhleSBhcmUgbm90IGhhbmRsZWQgYnkgdGhpcyBtZXRob2QuXG5cdHByaXZhdGUgYXN5bmMgZXhlY3V0ZVJlcXVlc3Q8VD4odXJpOnN0cmluZywgbWV0aG9kOnN0cmluZywgY29udGVudFR5cGVSZXNvdXJjZTpzdHJpbmcsIHJlcXVlc3RCb2R5PzphbnksIHF1ZXJ5UGFyYW1ldGVycz86YW55KTpQcm9taXNlPFQ+IHtcblx0XHRhd2FpdCB0aGlzLmluaXRDbGllbnQoKTtcblx0XHR1cmkgPSB1cmkucmVwbGFjZSgve3tjdXN0b21lcklEfX0vLCBlbmNvZGVVUklDb21wb25lbnQodGhpcy5jdXN0b21lcklEISkpO1xuXG5cdFx0bGV0IHFwID0gXCJcIjtcblx0XHRpZiAocXVlcnlQYXJhbWV0ZXJzKSB7XG5cdFx0XHRmb3IgKGNvbnN0IFtrLCB2XSBvZiBPYmplY3QuZW50cmllcyhxdWVyeVBhcmFtZXRlcnMpKSB7XG5cdFx0XHRcdGlmICh2ID09PSB1bmRlZmluZWQgfHwgdiA9PT0gbnVsbCkge1xuXHRcdFx0XHRcdGRlbGV0ZSBxdWVyeVBhcmFtZXRlcnNba107XG5cdFx0XHRcdH1cblx0XHRcdH1cblxuXHRcdFx0cXAgPSBcIj9cIiArIG5ldyBVUkxTZWFyY2hQYXJhbXMocXVlcnlQYXJhbWV0ZXJzKTtcblx0XHR9XG5cblx0XHRsZXQgcmVxdWVzdERhdGE6YW55ID0gdW5kZWZpbmVkO1xuXHRcdGlmIChyZXF1ZXN0Qm9keSkge1xuXHRcdFx0cmVxdWVzdERhdGEgPSAodHlwZW9mIHJlcXVlc3RCb2R5ID09PSBcInN0cmluZ1wiKSA/IHJlcXVlc3RCb2R5IDogSlNPTi5zdHJpbmdpZnkocmVxdWVzdEJvZHkpO1xuXHRcdH1cblxuXHRcdGxldCByZXNwb25zZUJvZHlUZXh0OnN0cmluZ3x1bmRlZmluZWQgPSB1bmRlZmluZWQ7XG5cdFx0bGV0IHJlc3BvbnNlQm9keTphbnkgPSB1bmRlZmluZWQ7XG5cblx0XHRsZXQgcmVzcG9uc2U6UmVzcG9uc2V8dW5kZWZpbmVkO1xuXG5cdFx0dHJ5IHtcblx0XHRcdHJlc3BvbnNlID0gYXdhaXQgZmV0Y2godGhpcy5iYXNlVXJsICsgdXJpICsgcXAsIHtcblx0XHRcdFx0bWV0aG9kLFxuXHRcdFx0XHRoZWFkZXJzOiB7XG5cdFx0XHRcdFx0XCJDb250ZW50LVR5cGVcIjogYGFwcGxpY2F0aW9uL3ZuZC5ub3RpZmljYXRpb24uJHtjb250ZW50VHlwZVJlc291cmNlfS52MStqc29uYCxcblx0XHRcdFx0XHRcIkF1dGhvcml6YXRpb25cIjogdGhpcy5hdXRob3JpemF0aW9uVG9rZW4sXG5cdFx0XHRcdH0sXG5cdFx0XHRcdGJvZHk6IHJlcXVlc3REYXRhLFxuXHRcdFx0fSk7XG5cdFx0XHRyZXNwb25zZUJvZHlUZXh0ID0gYXdhaXQgcmVzcG9uc2UudGV4dCgpO1xuXHRcdH0gY2F0Y2ggKGV4OmFueSkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9ycy5GZXRjaEVycm9yKChleCBhcyBFcnJvcikubWVzc2FnZSwgeyBjYXVzZTogZXggfSk7XG5cdFx0fVxuXG5cdFx0aWYgKCFyZXNwb25zZSkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9ycy5SZXNwb25zZUVycm9yKFwiU2VydmVyIGRpZCBub3QgcmVzcG9uZFwiKTtcblx0XHR9XG5cblx0XHRpZiAocmVzcG9uc2Uuc3RhdHVzID09PSA0MDEgfHwgcmVzcG9uc2Uuc3RhdHVzID09PSA0MDMpIHtcdC8vIEFXUyBIVFRQIEFQSSBHYXRld2F5IHJldHVybnMgNDAzIGZyb20gdGhlIGF1dGhvcml6ZXIgKGluc3RlYWQgb2YgNDAxKSBpZiB0aGUgY3JlZGVudGlhbHMgYXJlIGludmFsaWRcblx0XHRcdHRocm93IG5ldyBFcnJvcnMuQXV0aG9yaXphdGlvbkVycm9yKFwiQXV0aG9yaXphdGlvbiBGYWlsZWRcIik7XG5cdFx0fSBlbHNlIGlmIChyZXNwb25zZS5zdGF0dXMgPT09IDQwNCkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9ycy5SZXNwb25zZUVycm9yKFwiUmVzb3VyY2Ugbm90IGZvdW5kXCIpO1xuXHRcdH1cblxuXG5cdFx0dHJ5IHtcblx0XHRcdHJlc3BvbnNlQm9keSA9IHJlc3BvbnNlQm9keVRleHQgJiYgSlNPTi5wYXJzZShyZXNwb25zZUJvZHlUZXh0KTtcblx0XHR9IGNhdGNoIChleCkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9ycy5SZXNwb25zZUVycm9yKFwiSW52YWxpZCByZXNwb25zZSBjb250ZW50XCIsIHsgY2F1c2U6IHJlc3BvbnNlQm9keVRleHR9KTtcblx0XHR9XG5cblx0XHRpZiAocmVzcG9uc2Uuc3RhdHVzICE9IDIwMCkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9ycy5SZXNwb25zZUVycm9yKHJlc3BvbnNlQm9keS5FcnJvciB8fCByZXNwb25zZUJvZHlUZXh0KTtcblx0XHR9XG5cblx0XHRyZXR1cm4gcmVzcG9uc2VCb2R5IGFzIFQ7XG5cdH1cblxuXHQvLyBUaGVyZSBtdXN0IGJlIGEgY2xpZW50IGlkIHNwZWNpZmllZC4gSWYgd2UgZG9uJ3QgaGF2ZSBvbmUgdGhlbiByZXRyaWV2ZSB0aGUgdmFsdWUgZm9yIHRoZSBhdXRoZW50aWNhdGVkIGN1c3RvbWVyLlxuXHQvLyBUaGlzIGlzIGNhbGxlZCBiZWZvcmUgZWFjaCByZXF1ZXN0IHRvIHZlcmlmeSBhIGN1c3RvbWVyIElEIGlzIHByZXNlbnRcblx0cHJpdmF0ZSBhc3luYyBpbml0Q2xpZW50KCkge1xuXHRcdGlmICh0aGlzLmluaXRDb21wbGV0ZSkgcmV0dXJuO1xuXG5cdFx0dGhpcy5pbml0Q29tcGxldGUgPSB0cnVlO1x0Ly8gTWFyayBpbml0IGFzIGNvbXBsZXRlIGJlZm9yZSB0cmlnZ2VyaW5nIHRoZSBjdXN0b21lciBJRCBsb29rdXAgb3Igd2UgZ2V0IGNpcmN1bGFyIGNhbGxzXG5cblx0XHR0cnkge1xuXHRcdFx0Y29uc3QgZGF0YUl0ZW0gPSBhd2FpdCB0aGlzLmdldEluZm8oKTtcblx0XHRcdHRoaXMuY3VzdG9tZXJJRCA9IGRhdGFJdGVtLkN1c3RvbWVySUQ7XG5cdFx0fSBjYXRjaCAoZXgpIHtcblx0XHRcdHRoaXMuaW5pdENvbXBsZXRlID0gZmFsc2U7XG5cblx0XHRcdGNvbnN0IGVycm9yID0gZXggYXMgRXJyb3I7XG5cblx0XHRcdGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9ycy5BdXRob3JpemF0aW9uRXJyb3IpIHRocm93IGVycm9yO1xuXHRcdFx0ZWxzZSB0aHJvdyBuZXcgRXJyb3JzLkluaXRFcnJvcihgRmFpbGVkIHRvIGluaXQgY2xpZW50OiAke2Vycm9yLm1lc3NhZ2V9YCwgeyBjYXVzZTogZXJyb3IgfSk7XG5cdFx0fVxuXHR9XG5cblx0cHJpdmF0ZSBpc1VybCh2YWx1ZTpzdHJpbmcpOmJvb2xlYW4ge1xuXHRcdHRyeSB7XG5cdFx0XHRjb25zdCB1cmwgPSBuZXcgVVJMKHZhbHVlKTtcblx0XHRcdHJldHVybiB1cmwucHJvdG9jb2wgPT09IFwiaHR0cDpcIiB8fCB1cmwucHJvdG9jb2wgPT09IFwiaHR0cHM6XCI7XG5cdFx0fSBjYXRjaCB7IH1cblxuXHRcdHJldHVybiBmYWxzZTtcblx0fVxufVxuIl19